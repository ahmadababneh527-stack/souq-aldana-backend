{% extends 'base.html' %}
{% load static %}

{% block title %}تأكيد الدفع{% endblock %}

{% block content %}
<div class="auth-form-container otp-container">
    <div class="otp-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
        </svg>      
    </div>

    <h2>أدخل رمز التحقق</h2>
    <p class="otp-subtext">لقد أرسلنا رمزًا مكونًا من 6 أرقام إلى هاتفك المسجل.</p>
    <div id="countdown-timer"></div>

    <form id="otp-form" method="POST" action="{% url 'checkout_confirm' order_id=order.id %}">
        {% csrf_token %}
        <div class="otp-inputs">
            <input type="text" name="otp-1" class="otp-input" maxlength="1" required>
            <input type="text" name="otp-2" class="otp-input" maxlength="1" required>
            <input type="text" name="otp-3" class="otp-input" maxlength="1" required>
            <input type="text" name="otp-4" class="otp-input" maxlength="1" required>
            <input type="text" name="otp-5" class="otp-input" maxlength="1" required>
            <input type="text" name="otp-6" class="otp-input" maxlength="1" required>
        </div>
        <input type="hidden" name="pin_code" id="pin_code">
        
        <button type="submit" class="btn-primary">تأكيد الطلب</button>
    </form>

    <div class="resend-container">
        <p>لم تستلم الرمز؟ <a href="#">إعادة إرسال</a></p>
    </div>
</div>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const otpForm = document.getElementById('otp-form');
    const inputs = document.querySelectorAll('.otp-input');
    const hiddenInput = document.getElementById('pin_code');

    inputs.forEach((input, index) => {
        // --- وظيفة الانتقال التلقائي للحقل التالي ---
        input.addEventListener('keyup', (e) => {
            // الانتقال للأمام عند إدخال رقم
            if (e.key >= 0 && e.key <= 9 && index < inputs.length - 1) {
                if(inputs[index + 1]) {
                    inputs[index + 1].focus();
                }
            } 
            // الرجوع للخلف عند ضغط Backspace في حقل فارغ
            else if (e.key === 'Backspace' && index > 0) {
                 if(inputs[index - 1]) {
                    inputs[index - 1].focus();
                }
            }
        });

        // --- وظيفة دعم اللصق ---
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text');
            // تأكد أن النص الملصق هو 6 أرقام
            if (/^\d{6}$/.test(pasteData)) {
                for (let i = 0; i < pasteData.length; i++) {
                    if(inputs[i]) {
                       inputs[i].value = pasteData[i];
                    }
                }
                if(inputs[5]) {
                    inputs[5].focus(); // التركيز على آخر حقل بعد اللصق
                }
            }
        });
        
        // --- وظيفة منع إدخال الأحرف ---
        input.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });
    });

    // --- وظيفة تجميع الرمز قبل إرسال الفورم ---
    otpForm.addEventListener('submit', (e) => {
        let otpValue = '';
        inputs.forEach(input => {
            otpValue += input.value;
        });
        hiddenInput.value = otpValue; // تعبئة الحقل المخفي بالرمز الكامل
        
        // استدعاء Spinner إذا كانت موجودة
        if (typeof showSpinner === 'function') {
            showSpinner();
        }
    });
});

   document.addEventListener('DOMContentLoaded', function () {
        // المدة بالثواني (5 دقائق * 60 ثانية)
        let durationInSeconds = 5 * 60; 

        // العنصر الذي سيعرض الوقت
        const display = document.getElementById('countdown-timer');

        // بدء العد التنازلي
        let timer = setInterval(function () {
            // حساب الدقائق والثواني
            let minutes = Math.floor(durationInSeconds / 60);
            let seconds = durationInSeconds % 60;

            // إضافة صفر في البداية إذا كانت الثواني أقل من 10 (مثال: 09, 08)
            seconds = seconds < 10 ? "0" + seconds : seconds;

            // عرض الوقت المتبقي في العنصر
            display.textContent = "الوقت المتبقي: " + minutes + ":" + seconds;

            // عند انتهاء الوقت
            if (--durationInSeconds < 0) {
                clearInterval(timer); // إيقاف العداد
                display.textContent = "لم يصلك الرمز؟ يمكنك الآن الضغط على إعادة إرسال.";
            }
        }, 1000); // تشغيل هذه الدالة كل ثانية واحدة
    });
</script>
{% endblock %}