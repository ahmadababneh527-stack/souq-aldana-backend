{% extends 'base.html' %}

{% block title %}عنوان التوصيل{% endblock %}

{% block content %}
<div class="auth-form-container">
    <h2>الخطوة 1: عنوان التوصيل</h2>
    <form method="POST" action="{% url 'checkout_shipping' order_id=order.id %}">
        {% csrf_token %}
        <div class="form-group"><label>الاسم الأول:</label><input type="text" name="first_name" required></div>
        <div class="form-group"><label>الاسم الأخير:</label><input type="text" name="last_name" required></div>

        <div class="form-group">
            <label for="local_phone_number">رقم الهاتف:</label>
            <div class="phone-input-group">
                <select id="country_code" name="country_code" class="form-control country-code-select">
                    <option value="+962" selected>الأردن (+962)</option>
                    <option value="+966">السعودية (+966)</option>
                    <option value="+971">الإمارات (+971)</option>
                    <option value="+20">مصر (+20)</option>
                    <option value="+961">لبنان (+961)</option>
                </select>
                
                <input type="tel" id="local_phone_number" name="local_phone_number" class="form-control" placeholder="791234567" required>
            </div>
            <input type="hidden" id="full_phone_number" name="phone_number">
        </div>

        <div class="form-group"><label>الدولة:</label><input type="text" name="country" required></div>
        <div class="form-group"><label>العنوان (الشارع، المبنى):</label><input type="text" name="address" required></div>
        <div class="form-group"><label>الرمز البريدي:</label><input type="text" name="postal_code" id="postal_code"></div>

        <button type="submit" class="btn-primary">التالي &larr;</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- الحصول على كل العناصر اللازمة ---
            const countryCodeSelect = document.getElementById('country_code');
            const localPhoneInput = document.getElementById('local_phone_number');
            const fullPhoneNumberInput = document.getElementById('full_phone_number');
            const shippingForm = document.querySelector('form');
            const postalCodeInput = document.getElementById('postal_code');

            // --- 1. دالة لدمج رقم الهاتف مع رمز الدولة ---
            function updateFullPhoneNumber() {
                const countryCode = countryCodeSelect.value;
                const localPhone = localPhoneInput.value;
                fullPhoneNumberInput.value = countryCode + localPhone;
            }

            // --- 2. دالة لمنع إدخال أي شيء غير الأرقام ---
            function allowNumbersOnly(event) {
                this.value = this.value.replace(/\D/g, '');
            }

            // --- 3. تطبيق الدوال على العناصر ---
            countryCodeSelect.addEventListener('change', updateFullPhoneNumber);
            localPhoneInput.addEventListener('input', updateFullPhoneNumber);
            
            localPhoneInput.addEventListener('input', allowNumbersOnly);
            postalCodeInput.addEventListener('input', allowNumbersOnly); // تطبيق المنع على الرمز البريدي
            
            // --- 4. عرض Spinner عند إرسال النموذج ---
            if(shippingForm) {
                shippingForm.addEventListener('submit', function() {
                    // تأكد من وجود دالة showSpinner في ملفاتك العامة
                    if (typeof showSpinner === 'function') {
                        showSpinner();
                    }
                });
            }

            // --- 5. تحديث قيمة الرقم الكامل عند تحميل الصفحة أول مرة ---
            updateFullPhoneNumber();
        });
    </script>
{% endblock %}