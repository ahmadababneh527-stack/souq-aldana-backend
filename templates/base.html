{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}سوق الدانة{% endblock %}</title>

    <link rel="icon" type="image/png" href="{% static 'icons/favicon.png' %}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    {% block head_extra %}{% endblock %}
</head>
<body> 
    <div id="spinner-overlay" class="spinner-overlay">
        <div class="spinner"></div>
    </div>

    <div id="notification" class="notification"></div>

    <header class="main-header">
        <div class="container">
            <a href="{% url 'index' %}" class="logo-container">
                <img src="{% static 'images/special_offer.png' %}" alt="شعار سوق الدانة" class="logo-img">
                <h1 class="logo-text">سوق الدانة</h1>
            </a>
            
            <nav class="desktop-nav">
                <ul>
                    <li><a href="{% url 'index' %}">الرئيسية</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropbtn">الأقسام <i class="fa fa-caret-down"></i></a>
                        <div class="dropdown-content">
                            {% for category in categories %}
                                <a href="{% url 'category_products' category.slug %}">{{ category.name }}</a>
                            {% endfor %}
                        </div>
                    </li>
                    <li><a href="{% url 'cart' %}">سلة المشتريات (<span id="cart-count">0</span>)</a></li>
                     <li><a href="{% url 'track_order' %}">متابعة طلبي</a></li>
                     <li><a href="{% url 'my_books' %}">مكتبتي</a></li> <li><a href="{% url 'track_order' %}"><i class="fas fa-shipping-fast"></i> متابعة طلبي</a></li>
                     <li><a href="{% url 'my_books' %}"><i class="fas fa-book"></i> مكتبتي</a></li>
                     <li id="signup-link"><a href="{% url 'signup' %}">إنشاء حساب</a></li>
                     <li id="login-link"><a href="{% url 'login' %}">تسجيل الدخول</a></li>
                     <li id="user-info" style="display: none;">
                        <span id="user-display"></span>
                        <a href="#" id="logout-link">تسجيل الخروج</a>
                    </li>
                </ul>
            </nav>

            <button class="hamburger-menu" id="hamburger-button">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="search-container">
                <form action="/api/search/" method="get" class="search-form" id="search-form">
                    <input type="search" name="q" placeholder="ابحث عن منتجات..." class="search-input" required>
                </form>
                <button class="search-toggle-btn" id="search-toggle-btn" aria-label="Toggle Search">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="announcement-bar">
        <p>سيتم التوصيل مجانا خلال 48 ساعه وسيتم خصم المبلغ عند استلام المنتجات</p>
    </div>

    <div class="mobile-nav" id="mobile-nav">
        <nav>
            <ul>
                <li class="mobile-categories-item">
                    <details>
                        <summary><i class="fas fa-tags"></i> الأقسام</summary>
                        <ul class="mobile-categories-list">
                            {% for category in categories %}
                                <li><a href="{% url 'category_products' category.slug %}">{{ category.name }}</a></li>
                            {% endfor %}
                        </ul>
                    </details>
                </li>
                <li><a href="{% url 'index' %}"><i class="fas fa-home"></i> الرئيسية</a></li>
                <li><a href="#"><i class="fas fa-box-open"></i> المنتجات</a></li>
                <li><a href="{% url 'cart' %}"><i class="fas fa-shopping-cart"></i> سلة المشتريات (<span id="cart-count-mobile">0</span>)</a></li>
                <li><a href="{% url 'track_order' %}"><i class="fas fa-shipping-fast"></i> متابعة طلبي</a></li>
                <li id="signup-link-mobile"><a href="{% url 'signup' %}"><i class="fas fa-user-plus"></i> إنشاء حساب</a></li>
                <li id="login-link-mobile"><a href="{% url 'login' %}"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</a></li>
                <li id="user-info-mobile" style="display: none;">
                    <span id="user-display-mobile"></span>
                    <a href="#" id="logout-link-mobile"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="nav-overlay" id="nav-overlay"></div>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 سوق الدانة. كل الحقوق محفوظة.</p>
            <div class="footer-links">
                <a href="{% url 'terms' %}">شروط الاستخدام</a>
                <span>|</span>
                <a href="{% url 'privacy' %}">سياسة الخصوصية</a>
            </div>
        </div>
    </footer>

    {% block scripts %}
    <script>
    // ===================================
    // === دوال مساعدة عامة لكل الموقع ===
    // ===================================
    function showSpinner() {
        const spinner = document.getElementById('spinner-overlay');
        if (spinner) spinner.classList.add('show');
    }

    function hideSpinner() {
        const spinner = document.getElementById('spinner-overlay');
        if (spinner) spinner.classList.remove('show');
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = message;
        notification.className = 'notification show';
        notification.classList.add(type);
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // ===================================
    // === كود تفعيل الهيدر الموحد (النهائي) ===
    // ===================================
    document.addEventListener('DOMContentLoaded', function() {
        const searchContainer = document.querySelector('.search-container');
        const searchToggleBtn = document.getElementById('search-toggle-btn');
        const dropdown = document.querySelector('.desktop-nav .dropdown');
        const dropdownBtn = document.querySelector('.desktop-nav .dropdown .dropbtn');

        // --- تفعيل زر البحث ---
        if (searchToggleBtn && searchContainer) {
            searchToggleBtn.addEventListener('click', function(event) {
                event.stopPropagation(); // امنع الضغطة من الوصول للصفحة كلها
                // أغلق القائمة الأخرى قبل فتح هذه
                if (dropdown) dropdown.classList.remove('active');
                // افتح/أغلق قائمة البحث
                searchContainer.classList.toggle('active');
                if (searchContainer.classList.contains('active')) {
                    document.querySelector('.search-input').focus();
                }
            });
        }

        // --- تفعيل قائمة الأقسام ---
        if (dropdownBtn && dropdown) {
            dropdownBtn.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation(); // امنع الضغطة من الوصول للصفحة كلها
                // أغلق القائمة الأخرى قبل فتح هذه
                if (searchContainer) searchContainer.classList.remove('active');
                // افتح/أغلق قائمة الأقسام
                dropdown.classList.toggle('active');
            });
        }
    });

    // --- إغلاق القوائم المفتوحة عند الضغط في أي مكان آخر ---
    window.addEventListener('click', function(event) {
        const searchContainer = document.querySelector('.search-container');
        const dropdown = document.querySelector('.desktop-nav .dropdown');

        // أغلق قائمة البحث إذا كانت الضغطة خارجها
        if (searchContainer && !searchContainer.contains(event.target)) {
            searchContainer.classList.remove('active');
        }

        // أغلق قائمة الأقسام إذا كانت الضغطة خارجها
        if (dropdown && !dropdown.contains(event.target)) {
            dropdown.classList.remove('active');
        }
    });
    </script>
    {% endblock %}

    <script src="{% static 'js/nav-manager.js' %}"></script>
    <script src="{% static 'js/main.js' %}"></script>

</body>
</html>